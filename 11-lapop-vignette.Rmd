# AmericasBarometer Vignette {#c11-ambarom-vignette}

The AmericasBarometer surveys are conducted by the LAPOP Lab. These surveys are public opinion surveys of the Americas focused on democracy. The study was lunched in 2004/2005 with 11 countries with the countries growing and fluctuating over time and creates a study with consistent methodology across many countries. In 2021, the study included 22 countries ranging from the north in Canada to the South in Chile and Argentina^[https://www.vanderbilt.edu/lapop/about-americasbarometer.php].

Historically, surveys were administered with face-to-face household interviews but the COVID-19 pandemic changed the study significantly to the use of random-digit dialing (RDD) of mobile phones in all countries except the Untied States and Canada^[https://www.vanderbilt.edu/lapop/ab2021/AB2021-Technical-Report-v1.0-FINAL-eng-030722.pdfhttps://www.vanderbilt.edu/lapop/ab2021/AB2021-Technical-Report-v1.0-FINAL-eng-030722.pdf]. In Canada, LAPOP collaborated with the Environics Institute to collect data from a panel of Canadians using a web survey^[http://datasets.americasbarometer.org/database/files/ABCAN2021-Technical-Report-v1.0-FINAL-eng-110921.pdf]. While in the United States, YouGov conducted the survey on behalf of LAPOP by conducting a web survey among their panelists^[http://datasets.americasbarometer.org/database/files/ABUSA2021-Technical-Report-v1.0-FINAL-eng-110921.pdf].

The survey has a core set of questions asked across the countries but not all questions are asked everywhere. Additionally, some questions are only asked to half of respondents within a country, presumably to reduce burden as different sections are randomized to different respondents.^[https://www.vanderbilt.edu/lapop/ab2021/AB2021-Core-Questionnaire-v17.5-Eng-210514-W-v2.pdf] 

## Data Structure

Each country and each year has its own files. The data used in this vignette can be downloaded from the LAPOP website.  In this vignette, we will be using data from 2021, namely version v1.2. These are not available on the book's repository but you may download the raw files yourself^[http://datasets.americasbarometer.org/database/index.php] (@lapopdat). To read all files into R and ignore the Stata labels, we recommend running code like this:

```
stata_files <- list.files(here("RawData", "LAPOP_2021"), "*.dta")

read_stata_unlabeled <- function(file){
  read_stata(file) %>%
    zap_labels() %>%
    zap_label()
}
  
lapop_in <- here("RawData", "LAPOP_2021", stata_files) %>%
  map_df(read_stata_unlabeled)
```

The code above will read all files of type `dta` in and stack them into one tibble. We did this and then selected a subset of variables for this vignette. To understand varaibles that are used across the several countries, the core questionnaire is useful.^[https://www.vanderbilt.edu/lapop/ab2021/AB2021-Core-Questionnaire-v17.5-Eng-210514-W-v2.pdf] 

## Preparing files

Many of the variables are coded as numeric and do not have intuitive variable names so the next step is to create derived variables and analysis ready data. Using the core questionnaire as a codebook, derived variables are created below with factors where relevant with informative names.

```{r}
#| label: ambarom-derive
#| message: false
library(tidyverse)
library(srvyr)
library(sf)
library(rnaturalearth) #getting world maps
library(gt)
library(ggpattern)
library(osfr)

ambarom_in <- osf_retrieve_node("https://osf.io/gzbkn/?view_only=8ca80573293b4e12b7f934a0f742b957") %>%
  osf_ls_files() %>%
  filter(name=="lapop_2021.rds") %>%
  osf_download(conflicts="overwrite", path="osf_dl") %>%
  pull(local_path) %>%
  read_rds()

ambarom <- ambarom_in %>%
  mutate(
    Country=factor(case_match(
      pais,
      1~"Mexico",
      2~"Guatemala",
      3~"El Salvador",
      4~"Honduras",
      5~"Nicaragua",
      6~"Costa Rica",
      7~"Panama",
      8~"Colombia",
      9~"Ecuador",
      10~"Bolivia",
      11~"Peru",
      12~"Paraguay",
      13~"Chile",
      14~"Uruguay",
      15~"Brazil",
      17~"Argentina",
      21~"Dominican Republic",
      22~"Haiti",
      23~"Jamaica",
      24~"Guyana",
      40~"United States",
      41~"Canada"
    )),
    
    Gender=fct_reorder(case_match(
      q1tb,
      1~"Male",
      2~"Female",
      3~"Other"
    ), q1tb, .na_rm=FALSE),
    CovidWorry=fct_reorder(case_match(
      covid2at,
      1~"Very worried",
      2~"Somewhat worried",
      3~"A little worried",
      4~"Not worried at all"
    ), covid2at, .na_rm=FALSE),
    MostSeriousProblem=fct_reorder(case_match(
      a4,
      30~"Armed conflict",
      15~"Bad government",
      71~"COVID-19 pandemic",
      13~"Corruption",
      9~"Credit, lack of",
      5~"Crime",
      11~"Drug addiction",
      1~"Economy",
      21~"Education",
      24~"Electricity",
      10~"Environment",
      26~"External debt",
      32~"Forced displacement of persons",
      14~"Gangs",
      22~"Health services, lack of",
      55~"Housing",
      56~"Human rights, violations of",
      61~"Impunity",
      58~"Inequality",
      863~"BACRIM/Paramilitaries",
      2~"Inflation, high prices",
      31~"Kidnappings",
      7~"Land to farm, lack of",
      23~"Malnutrition",
      16~"Migration",
      59~"Politicians",
      85~"Politics",
      6~"Populatr protests",
      4~"Poverty",
      18~"Roads in poor condition",
      27~"Security (lack of)",
      33~"Terrorism",
      60~"Transportation",
      3~"Unemployment",
      86~"Vaccines for COVID-19, lack of",
      57~"Violence",
      80~"Violence against women",
      17~"War against terrorism",
      19~"Water, lack of",
      70~"Other",
      862~"The guerilla",
      864~"Peace",
      865~"Agricultural policy"# Found in Colombia questionnaire
    ), a4, .na_rm=FALSE),
    EconSituation=fct_reorder(case_match(
      idio2,
      1~"Better",
      2~"Same",
      3~"Worse"
    ), idio2, .na_rm=FALSE),
    EconSituationWorse_Reason=fct_reorder(case_match(
      idio2cov,
      1~"Coronavirus",
      2~"Another reason"
    ), idio2cov, .na_rm=FALSE),
    CommunityTrustworthy=fct_reorder(case_match(
      it1,
      1~"Very trustworthy",
      2~"Somewhat trustworthy",
      3~"Not very trustworthy",
      4~"Untrustworthy"
    ), it1, .na_rm=FALSE),
    CoupCorruption=fct_reorder(case_match(
      jc13,
      1~"Justified",
      2~"Not justified"
    ), jc13, .na_rm=FALSE),
    LeaderApproval=fct_reorder(case_match(
      m1,
      1~"Very good",
      2~"Good",
      3~"Neither good nor bad (fair)",
      4~"Bad",
      5~"Very bad"
    ), m1, .na_rm=FALSE),
    ChinaTrustworthy=fct_reorder(case_match(
      mil10a,
      1~"Very trustworthy",
      2~"Somewhat trustworthy",
      3~"Not very trustworthy",
      4~"Not at all trustworthy"
    ), mil10a, .na_rm=FALSE),
    USTrustworthy=fct_reorder(case_match(
      mil10e,
      1~"Very trustworthy",
      2~"Somewhat trustworthy",
      3~"Not very trustworthy",
      4~"Not at all trustworthy"
    ), mil10e, .na_rm=FALSE),
    ChinaInfluenceAmount=fct_reorder(case_match(
      ccch1,
      1~"A lot",
      2~"Some",
      3~"Little",
      4~"None"
    ), ccch1, .na_rm=FALSE),
    USInfluenceAmount=fct_reorder(case_match(
      ccus1,
      1~"A lot",
      2~"Some",
      3~"Little",
      4~"None"
    ), ccus1, .na_rm=FALSE),
    ChinaInfluenceQual=fct_reorder(case_match(
      ccch3,
      1~"Positive",
      2~"Neither positive nor negative",
      3~"Negative"
    ), ccch3, .na_rm=FALSE),
    USInfluenceQual=fct_reorder(case_match(
      ccus3,
      1~"Positive",
      2~"Neither positive nor negative",
      3~"Negative"
    ), ccus3, .na_rm=FALSE),
    Education=fct_reorder(case_match(
      edr,
      0~"None",
      1~"Primary",
      2~"Secondary",
      3~"Tertiary, university, or higher"
    ),edr, .na_rm=FALSE),
    Employment=fct_reorder(case_match(
      ocup4a,
      c(1,2)~"Working",
      3~"Looking for a job",
      4~"Student",
      5~"Homemaker",
      6~"Retired or disabled",
      7~"Not working, not looking for job"
    ), ocup4a, .na_rm=FALSE),
     IntentionMigrate=fct_reorder(case_match(
      q14,
      1~"Yes",
      2~"No"
    ), q14, .na_rm=FALSE),
    MaritalStatus=fct_reorder(case_match(
      q11n,
      1~"Single",
      2~"Married",
      3~"Common law marriage/living together",
      4~"Divorced",
      5~"Separated",
      6~"Widowed",
      7~"Civil union"
    ), q11n, .na_rm=FALSE),
    NewsFrequency=fct_reorder(case_match(
      gi0n,
      1~"Daily",
      2~"Few times a week",
      3~"Few times a month",
      4~"Few times a year",
      5~"Never"
    ), gi0n, .na_rm=FALSE)
  ) %>%
  rename(
    COVID_Educ_NotInSchool=covidedu1_1,
    COVID_Educ_NormalSchool=covidedu1_2,
    COVID_Educ_VirtualSchool=covidedu1_3,
    COVID_Educ_Hybrid=covidedu1_4,
    COVID_Educ_NoSchool=covidedu1_5,
    Age=q2,
    HHSize=q12c,
    HHChildren=q12bn,
    ComputerTablet=r15,
    BroadbandInternet=r18n,
    Internet=r18
  )


# ambarom %>% count(Country, pais) %>% print(n=22)
# ambarom %>% count(Gender, q1tb)
# ambarom %>% count(MostSeriousProblem, a4) %>% print(n=50)
# ambarom %>% count(EconSituation, idio2)
# ambarom %>% count(EconSituationWorse_Reason, idio2cov)
# ambarom %>% count(CommunityTrustworthy, it1)
# ambarom %>% count(CoupCorruption, jc13)
# ambarom %>% count(LeaderApproval, m1)
# ambarom %>% count(ChinaTrustworthy, mil10a)
# ambarom %>% count(USTrustworthy, mil10e)
# ambarom %>% count(ChinaInfluenceAmount, ccch1)
# ambarom %>% count(USInfluenceAmount, ccus1)
# ambarom %>% count(ChinaInfluenceQual, ccch3)
# ambarom %>% count(USInfluenceQual, ccus3)
# ambarom %>% count(Education, edr)
# ambarom %>% count(Employment, ocup4a)
# ambarom %>% count(IntentionMigrate, q14)
# ambarom %>% count(MaritalStatus, q11n)
# ambarom %>% count(NewsFrequency, gi0n)
```

## Survey design objects

The technical report is the best source to understand how to specify the sampling design in R^[https://www.vanderbilt.edu/lapop/ab2021/AB2021-Technical-Report-v1.0-FINAL-eng-030722.pdf]. The data includes two weights: `wt` and `weight1500`. The first weight variable is country specific and sums to the sample size but is calibrated to reflect each country's demographics while the second weight variable sums to 1500 for each country. The second weight is indicated as the weight to use for multi country analyses. While the documentation does not directly state this, the example Stata syntax `svyset upm [pw=weight1500], strata(strata)` indicates the variable `upm` is a clustering variable and `strata` is the strata variable thus the design object is setup as follows:

```{r}
#| label: ambarom-design

ambarom_des <- ambarom %>%
  as_survey_design(ids=upm, strata=strata, weight=weight1500)
```

One interesting thing to note is that these can only give us estimates to compare countries but not a multi-country estimate since the weights do not account for different sizes of countries. For example, Canada has about 10% of the population of the Untied States but an estimate that uses records from both countries would weight them equally. 

## Calculating estimates and disemminating

### COVID topics

This survey was administered in 2021 between March and August, varying by country^[See Table 2 in https://www.vanderbilt.edu/lapop/ab2021/AB2021-Technical-Report-v1.0-FINAL-eng-030722.pdf for dates by country]. Given the state of the pandemic at that time, several questions about COVID were included. The first question about COVID asked whether people were worried about the possibility that they or someone in their household will get sick from coronavirus in the next 3 months. We will calculate the percent of people in each country who are very worried or somewhat worried. In the following code, estimates are calculated and then using the {{gt}} package, a table of the estimates is created.

```{r}
#| label: ambarom-est1

covid_worry_country_ests <-
  ambarom_des %>%
  mutate(
    CovidWorry_bin=fct_collapse(
      CovidWorry,
      WorriedHi=c("Very worried", "Somewhat worried"),
      WorriedLo=c("A little worried", "Not worried at all")
    )) %>%
  filter(!is.na(CovidWorry_bin)) %>%
  group_by(Country) %>%
  summarise(
    p=survey_mean(CovidWorry_bin=="WorriedHi")*100
  ) 

covid_worry_country_ests %>%
  gt(rowname_col = "Country") %>%
  cols_label(
    p="Percent",
    p_se="SE"
  ) %>%
  tab_header(
    title="Proportion worried about the possibility that they or someone in their household will get sick from coronavirus in the next 3 months"
  )



```

While the table presents the data well, a map could also be used. To obtain maps of the countries, the package {{rnaturalearth}} is used subsetting North and South America using the function `ne_countries()`. This returns an sf object with many columns but most importantly `soverignt` (soverignty), `geounit` (country or territory), and `geometry` (the shape). The United States, Puerto Rico, and the US Virgin Islands are all separate units but have the same sovereignty.

That map (without data) is plotted. In the first map, the map is very wide as the Aleutian islands in Alaska extend into the Eastern Hemisphere. The shape file is cropped to only the Western Hemisphere to remove some of the trailing islands of Alaska and then plotted. 

```{r}
#| label: americas-map
#| fig.cap: "Map of North and South America"
country_shape <- ne_countries(scale = "medium", returnclass = "sf", continent=c("North America", "South America"))

country_shape %>%
  ggplot() + geom_sf()
```

```{r}
#| label: americas-map-crop
#| fig.cap: "Map of North and South America, cropped to the Western Hemisphere"
country_shape %>%
  st_crop(c(xmin=-180, xmax=0, ymin=-90, ymax=90)) %>%
  ggplot() + geom_sf()

```

Then, using the `anti_join()` function, it is verified that all countries in the survey data are also in the map data. As shown below, United States is referred to as "United States" in the survey data but "Untied States of America" in the map data. 

```{r}
#| label: map-merge-check

survey_country_list <- ambarom %>% distinct(Country) 
survey_country_list %>% anti_join(country_shape, by=c("Country"="geounit"))
country_shape %>% as_tibble() %>% select(geounit, sovereignt) %>% 
  anti_join(survey_country_list, by=c("geounit"="Country")) %>%
  arrange(geounit) %>%
  print(n=30)
```


With the mismatched names, there are several ways to remedy the data to be able to join later. The simplest fix is to rename the data on the shape object before doing any merging. We then can plot the survey estimates after merging on the data.

```{r}
#| label: update-map-usa

country_shape_upd <- country_shape %>% 
  mutate(geounit=if_else(geounit=="United States of America", "United States", geounit)) %>%
  st_crop(c(xmin=-180, xmax=0, ymin=-90, ymax=90)) 
```


To merge on the data and make a map, we begin with the map file, merge on the estimates data, and then plot as shown below.

```{r}
#| label: make-maps-covid
#| fig.cap="Percent of people worried someone in their household will get COVID-19 in the next 3 months by country"

covid_worry_sf <- country_shape_upd %>%
  full_join(covid_worry_country_ests, by=c("geounit"="Country")) 

ggplot() +
  geom_sf(data=covid_worry_sf, aes(fill=p, geometry=geometry)) +
  scale_fill_gradientn(guide="colourbar",name="Percent", labels=scales::comma, 
                       colours=c("#BFD7EA", "#087E8B", "#0B3954"), na.value=NA) +
  geom_sf_pattern(data=filter(covid_worry_sf, is.na(p)), pattern="crosshatch", pattern_fill="black", fill=NA)
```


