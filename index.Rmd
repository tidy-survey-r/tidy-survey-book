--- 
title: "Exploring Complex Survey Data Analysis in R"
subtitle: "A Tidy Introduction with srvyr"
author: "Stephanie Zimmer, Rebecca J. Powell, and Isabella Vel√°squez"
date: "`r Sys.Date()`"
documentclass: krantz
bibliography: [book.bib, packages.bib]
biblio-style: apalike
link-citations: yes
colorlinks: true
lot: true
lof: true
site: bookdown::bookdown_site
description: "Bookdown for upcoming book on survey analysis the tidy way."
github-repo: tidy-survey-r/tidy-survey-book
graphics: yes
#cover-image: images/cover.jpg
header-includes:
   - \usepackage{draftwatermark}
   - \usepackage[titles]{tocloft}
---

\SetWatermarkText{DRAFT}


```{r setup}
#| include: false
options(
  htmltools.dir.version = FALSE, formatR.indent = 2, digits = 4
)
if (knitr:::is_html_output()){
  options(width=72)
} else{
  options(width=72)
}

library(prettyunits)

book_colors <- c("#0b3954", "#087e8b", "#bfd7ea", "#ff8484", "#8d6b94")

as_latex_with_caption <- function(gtobj, chunk_label) {
  gt_l <- gt::as_latex(gtobj)
  caption <- paste0(
    "\\caption{\\label{tab:", chunk_label, "}(ref:", chunk_label, ")}\\\\")
  latex <- strsplit(gt_l[1], split = "\n")[[1]]
  idxtable <- which(stringr::str_detect(latex, "begin") & stringr::str_detect(latex, "table"))
  # https://tex.stackexchange.com/questions/95236/as-first-character-in-table-row 
  idxparen <- which(stringr::str_detect(latex, "^\\("))
  if (length(idxparen)>0){
    latex[(idxparen-1)] <- stringr::str_c(latex[(idxparen-1)], "\\relax")
  }
  latex2 <- c(latex[1:idxtable], caption, latex[-c(1:idxtable)])
  latex3 <- paste(latex2, collapse = "\n")
  gt_l[1] <- latex3
  return(gt_l)
}

print_gt_book <- function(gtobj, ref){
  if ("gtsummary" %in% class(gtobj)){
    gtobj <- as_gt(gtobj)
  }
  
  if (knitr::is_latex_output()){
    gtobj %>%
      as_latex_with_caption(ref)
  } else {
    gtobj %>% 
      tab_caption(glue::glue("(ref:{ref})"))
  }
  
  
}

```

`r if (knitr:::is_html_output()) '# Dedication {-}'`

```{r}
#| label: index-dedication-text
#| echo: false
#| results: asis

sz_thanks <- "Stephanie would like to thank her family in their support and encouragement. In particular, Will helped a lot during the many weekends and evenings of writing to make sure our household kept going. Thanks to my parents and grandparents who always checked on the progress and encouraged me to keep going."

rjp_thanks <- "Rebecca ..."

iv_thanks <- "Isabella ..."

if (knitr:::is_html_output()){
  cat(paste(c(sz_thanks, rjp_thanks, iv_thanks), collapse="\\\n\\\n"))
} else if(knitr:::is_latex_output()){
  bb <- readLines(here::here("latex", "before_body_temp.tex"))
  ph <- which(bb=="placeholder")
  ded <- c(sz_thanks, "", rjp_thanks, "", iv_thanks)
  writeLines(c(bb[1:(ph-1)], ded, bb[(ph+1):length(bb)]), here::here("latex", "before_body_ded.tex"))
  rm(ph, bb, ded)
}

rm(sz_thanks, rjp_thanks, iv_thanks)
```
